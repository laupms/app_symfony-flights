{% extends 'base.html.twig' %}

{% block title %}flights - Liste des réductions{% endblock %}

{% block body %}

<section class="hero-discount">
    <div class="hero-discount-content">
        <h1>Reductions</h1>
    </div>
</section>

<div class="d-flex justify-content-between align-items-center mb-3 p-3">
    
    <div class="d-flex gap-3">
        <select id="sortByDate" class="form-select">
            <option value="desc">Plus récents</option>
            <option value="asc">Plus anciens</option>
        </select>

        <select id="filterByAirline" class="form-select">
            <option value="all">Toutes les compagnies</option>
            {% for al in airline %}
                <option value="{{ al.name }}">{{ al.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<section class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-12">

            <table id="discountTable" class="table text-center table-width">
                <thead style="border-style:hidden;">
                    <tr>
                        <th class="title-info">Montant</th>
                        <th class="title-info">Compagnie</th>
                        <th class="title-info">Validité</th>
                        <th class="title-info"></th>
                    </tr>
                </thead>
                <tbody style="vertical-align:middle;">

                {% for discount in discounts %}

                    <tr data-airline="{{ discount.airline.name }}" data-date="{{ discount.dateStart|date('d-m-Y') }}">
                        <td>- {{ discount.value }} €</td>
                        <td><img src="{{ asset('img/logo-airlines/' ~ discount.airline.logo) }}" alt="{{ discount.airline.name }}" width="100"></td>
                        <td>Du {{ discount.dateStart ? discount.dateStart|date('d/m/Y') : '' }} au {{ discount.dateEnd ? discount.dateEnd|date('d/m/Y') : '' }}</td>

                        <td class="d-flex actions">
                            <button class="btn edit-btn actions-size m-1" title="Modifier" aria-label="Modifier">
                                    <a href="{{ path('admin_discount_edit', {'id': discount.id}) }}" style="text-decoration:none; color:#ffffff;">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </a>
                            </button>

                            {{ include('admin/discount/_delete_form.html.twig') }}
                        </td>
                    </tr>
                    <tr class="spacer" style="height:50px;"></tr>
                {% else %}
                    <tr>
                        <td colspan="6">no records found</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <div id="noResultsMessage" class="text-center my-3 title-info" style="display: none; font-weight: 500;">
                Aucune réduction ne correspond à votre recherche.
            </div>

            <div class="btn-center">
                <a class="btn-slide slide-right" href="{{ path('admin_discount_new')}}" style="text-decoration:none;"><i class="fa-solid fa-plus p-2" aria-hidden="true"></i>Créer une nouvelle réduction</a>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const rows = Array.from(document.querySelectorAll('#discountTable tr[data-date]'));
    const sortSelect = document.getElementById('sortByDate');
    const filterSelect = document.getElementById('filterByAirline');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const tbody = document.querySelector('#discountTable tbody') || document.querySelector('#discountTable');

    function updateTable() {

        tbody.classList.add('tr-fade');

        setTimeout(() => {
            let filteredRows = rows;
            const selectedAirline = filterSelect.value;

            if (selectedAirline !== 'all') {
                filteredRows = filteredRows.filter(row => row.dataset.airline === selectedAirline);
            }

            const sortedRows = filteredRows.sort((a, b) => {
                const dateA = new Date(a.dataset.date);
                const dateB = new Date(b.dataset.date);
                return sortSelect.value === 'asc' ? dateA - dateB : dateB - dateA;
            });

            tbody.innerHTML = '';

            if (sortedRows.length === 0) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';

                sortedRows.forEach((row) => {
                    tbody.appendChild(row);
                    const spacer = document.createElement('tr');
                    spacer.classList.add('spacer');
                    spacer.style.height = '50px';
                    tbody.appendChild(spacer);
                });

            }

            tbody.classList.remove('tr-fade');
        }, 300);
    }

    sortSelect.addEventListener('change', updateTable);
    filterSelect.addEventListener('change', updateTable);
});
</script>

{% endblock %}
